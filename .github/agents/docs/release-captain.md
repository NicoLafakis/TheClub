# üöÄ Release Captain Agent

## Overview

The Release Captain manages the release process, maintaining changelogs, suggesting version bumps, and preparing release notes. It acts as a dedicated release manager ensuring consistent, documented releases.

## What It Does

The Release Captain:

- **Tracks Unreleased Changes**: Monitors commits since last release
- **Generates Changelogs**: Creates user-focused changelog entries
- **Suggests Version Bumps**: Determines appropriate version increments
- **Prepares Release Notes**: Formats releases for GitHub and users
- **Creates Release PRs**: Automates release preparation workflow
- **Follows Conventions**: Adheres to semantic versioning and conventional commits

## How It Works

### Trigger Events

The Release Captain runs when:
- **Push to Main** - Checks for unreleased changes after merge
- **Daily at 8am UTC** - Scheduled release readiness check
- **Manual Trigger** - On-demand release preparation with version type

### Workflow Process

1. **Checkout Code**: Gets full git history
2. **Find Last Release**: Identifies most recent release tag
3. **Count Commits**: Determines if new commits exist since last release
4. **Analyze Commits**: Examines commit messages for version bump hints
5. **Calculate Version**: Determines next version (major/minor/patch)
6. **Generate Changelog**: Creates formatted changelog entry
7. **Create Release PR**: Opens PR with changelog and version bump
8. **Label Appropriately**: Tags with `release` and `agent-generated`

### Version Bump Logic

**Major (X.0.0)** - Breaking changes:
- Commit messages with `BREAKING CHANGE` or `!` suffix
- Example: `feat!: redesign authentication API`

**Minor (x.Y.0)** - New features:
- Commit messages starting with `feat:`
- Example: `feat: add dark mode support`

**Patch (x.y.Z)** - Bug fixes:
- Commit messages starting with `fix:`
- Example: `fix: resolve memory leak in cache`

## Configuration Options

### In `.github/agents/config.yml`

```yaml
agents:
  release-captain:
    enabled: true
    schedule: "0 8 * * *"  # 8 AM UTC
    
    # Version bump rules
    version:
      # Keywords that trigger specific bumps
      major_keywords: ["BREAKING", "!:"]
      minor_keywords: ["feat"]
      patch_keywords: ["fix", "patch", "bugfix"]
    
    # Changelog settings
    changelog:
      file: "CHANGELOG.md"
      format: "keepachangelog"  # or "conventional"
      include_commit_links: true
      group_by_type: true
    
    # Auto-release settings
    auto_release:
      enabled: false          # Require manual merge
      branches: ["main"]
      create_github_release: true
```

### Workflow Configuration

Located at `.github/workflows/agent-release-captain.yml`

Key settings:
- Two-job workflow: check + prepare-release
- Uses git tags to find last release
- Parses conventional commit format
- Creates PR with release changes

## Changelog Format

The agent generates changelog entries following Keep a Changelog format:

```markdown
## [1.2.0] - 2024-12-30

### ‚ö†Ô∏è Breaking Changes
- API authentication now required for all endpoints (#234)
  - Migration: Add `Authorization` header to requests
  - See docs/migration-v1-to-v2.md for details

### ‚ú® Features
- Add dark mode support (#245)
- Implement user preferences panel (#248)
- Add export to CSV functionality (#251)

### üêõ Bug Fixes
- Fix memory leak in event listeners (#243)
- Resolve crash when uploading large files (#246)
- Correct timezone handling in date picker (#250)

### üîß Improvements
- Optimize database queries for user search (#247)
- Improve error messages in validation (#249)
- Reduce bundle size by 15% (#252)

### üìö Documentation
- Add API authentication guide (#244)
- Update deployment instructions (#253)

### üèóÔ∏è Internal
- Refactor authentication module (#242)
- Update dependencies (#254)
- Improve CI pipeline speed (#255)
```

### Changelog Sections

The Release Captain organizes changes by impact:

1. **‚ö†Ô∏è Breaking Changes** - Must be communicated clearly
2. **‚ú® Features** - New functionality
3. **üêõ Bug Fixes** - Resolved issues
4. **üîß Improvements** - Enhancements to existing features
5. **üìö Documentation** - Documentation updates
6. **üèóÔ∏è Internal** - Refactoring, dependencies, CI changes

## Release PR Format

The agent creates a PR with this structure:

```markdown
## üöÄ Release v1.2.0

This PR was automatically generated by the Release Captain.

### Changes Since v1.1.0

**Type**: Minor release (new features)
**Commits**: 15
**Contributors**: 3 (@alice, @bob, @charlie)

### Summary

This release adds dark mode support and improves performance. It includes 3 new features, 5 bug fixes, and several internal improvements.

### Full Changelog

[Changelog entry content from above]

### Checklist

- [ ] Changelog reviewed and accurate
- [ ] Version bump is appropriate (minor)
- [ ] All CI checks pass
- [ ] Documentation updated if needed
- [ ] Breaking changes communicated (N/A for this release)

### Deployment Steps

1. Merge this PR
2. Wait for CI to complete
3. Create GitHub release from tag
4. Deploy to production
5. Send release announcement

---

**Merge this PR to create the release tag and publish.**

*Generated by Release Captain ‚Ä¢ Based on conventional commits*
```

## Manual Release Creation

### Specify Version Type

```bash
gh workflow run agent-release-captain.yml \
  -f release_type=minor
```

Options: `auto`, `patch`, `minor`, `major`

### Via GitHub UI

1. Go to Actions tab
2. Select "Release Captain"
3. Click "Run workflow"
4. Select release type
5. Click "Run workflow"

## Best Practices

### For Maintainers

1. **Use Conventional Commits**: Enables automatic version detection
2. **Review Release PRs**: Don't auto-merge, verify changelog
3. **Merge to Create Release**: Merging release PR should trigger tagging
4. **Tag Properly**: Use semantic versioning (v1.2.3)
5. **Document Breaking Changes**: Always include migration guides

### For Contributors

1. **Write Descriptive Commits**: Helps generate better changelogs
2. **Use Conventional Format**: `feat:`, `fix:`, `docs:`, etc.
3. **Mark Breaking Changes**: Use `!` or `BREAKING CHANGE` in footer
4. **Reference Issues**: Include issue numbers (#123)
5. **Group Related Changes**: Squash commits for cleaner changelog

## Commit Message Guidelines

### Conventional Commit Format

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

### Types

- `feat:` - New feature
- `fix:` - Bug fix
- `docs:` - Documentation only
- `style:` - Code style (formatting, missing semi colons)
- `refactor:` - Code refactoring
- `perf:` - Performance improvements
- `test:` - Adding tests
- `chore:` - Maintenance tasks
- `ci:` - CI configuration changes

### Examples

**Feature**:
```
feat(auth): add OAuth2 login support

Implements OAuth2 authentication flow for Google and GitHub.
Users can now log in using their existing accounts.

Closes #123
```

**Breaking Change**:
```
feat(api)!: require authentication for all endpoints

BREAKING CHANGE: All API endpoints now require authentication.
Add Authorization header with valid JWT token.

Migration guide: docs/migration-v1-to-v2.md
```

**Bug Fix**:
```
fix(upload): prevent crash with files >10MB

Files larger than 10MB were causing server crashes.
Now properly streams large files using multipart upload.

Fixes #456
```

## Customization

### Changelog Style

Edit `.github/agents/prompts/release-captain.md` to:
- Change emoji usage
- Adjust section organization
- Modify detail level
- Add custom sections

### Version Calculation

Customize bump logic:

```yaml
- name: Custom version logic
  run: |
    # Example: Always bump minor if any features
    if git log $LAST_TAG..HEAD | grep -q "feat:"; then
      echo "bump=minor" >> $GITHUB_OUTPUT
    fi
```

### GitHub Releases

Auto-create GitHub releases:

```yaml
- name: Create GitHub Release
  if: github.ref == 'refs/heads/main'
  uses: actions/create-release@v1
  with:
    tag_name: ${{ steps.version.outputs.new_version }}
    release_name: Release ${{ steps.version.outputs.new_version }}
    body_path: changelog-entry.md
    draft: false
    prerelease: false
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## Troubleshooting

### No Release Created

**Symptoms**: Workflow runs but no release PR appears

**Solutions**:
- Check if commits exist since last release
- Verify git tags are accessible
- Check PR creation permissions
- Review workflow logs

### Wrong Version Bump

**Symptoms**: Version increment doesn't match changes

**Solutions**:
- Review commit messages for correct types
- Check `version` configuration
- Use manual trigger to specify type
- Ensure breaking changes are marked

### Changelog Missing Entries

**Symptoms**: Some commits not in changelog

**Solutions**:
- Verify commit message format
- Check if commit types are excluded
- Ensure commits are after last tag
- Review changelog generation logic

### Duplicate Entries

**Symptoms**: Same change appears multiple times

**Solutions**:
- Ensure release PRs are merged, not rebased
- Don't create manual releases between agent releases
- Squash related commits before merging

## Advanced Features

### Pre-Release Versions

Support alpha/beta/rc versions:

```yaml
- name: Determine pre-release
  if: github.ref != 'refs/heads/main'
  run: |
    VERSION="${{ steps.version.outputs.new_version }}-rc.1"
    echo "new_version=$VERSION" >> $GITHUB_OUTPUT
```

### Multi-Package Releases

For monorepos:

```yaml
- name: Detect changed packages
  run: |
    PACKAGES=$(git diff --name-only $LAST_TAG..HEAD | \
      grep "packages/" | cut -d/ -f2 | sort -u)
    # Create release for each package
```

### Automated Deployment

Trigger deployment on release:

```yaml
on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to production
        run: ./scripts/deploy.sh ${{ github.event.release.tag_name }}
```

### Release Notes Distribution

Share release notes:

```yaml
- name: Post to Slack
  run: |
    curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
      -H 'Content-Type: application/json' \
      -d "{\"text\": \"New release: $VERSION\"}"
```

## Integration with Other Tools

### Package Publishing

Auto-publish to npm/PyPI:

```yaml
- name: Publish to npm
  if: github.event_name == 'release'
  run: |
    npm publish
  env:
    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### Version File Updates

Update version files:

```yaml
- name: Update package.json
  run: |
    npm version ${{ steps.version.outputs.new_version }} --no-git-tag-version
```

### Release Metrics

Track release frequency:

```yaml
- name: Record release metrics
  run: |
    echo "$(date),$NEW_VERSION,$COMMIT_COUNT" >> .github/release-metrics.csv
```

## Performance Considerations

- **Analysis Time**: 30-60 seconds per run
- **API Usage**: ~1500 tokens per changelog
- **Git Operations**: Requires full history
- **Scalability**: Handles repositories with 1000s of commits

## Related Documentation

- [Codebase Librarian](./librarian.md) - Release context
- [PR Prep Agent](./pr-prep.md) - PR formatting
- [Code Review Agent](./code-review.md) - Release PR review
