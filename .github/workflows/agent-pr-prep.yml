name: PR Prep Agent

on:
  pull_request:
    types: [opened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    # Only run if PR has no description or minimal description (including whitespace-only)
    if: github.event.pull_request.body == '' || github.event.pull_request.body == null || (github.event.pull_request.body != null && github.event.pull_request.body == fromJSON('"\n"')) || (github.event.pull_request.body != null && github.event.pull_request.body == fromJSON('" "'))

    steps:
      - name: Check if PR needs description
        id: check
        run: |
          BODY="${{ github.event.pull_request.body }}"
          # Trim whitespace and check if empty
          TRIMMED=$(echo "$BODY" | tr -d '[:space:]')
          if [ -z "$TRIMMED" ]; then
            echo "needs_description=true" >> $GITHUB_OUTPUT
          else
            echo "needs_description=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.check.outputs.needs_description == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gather PR context
        if: steps.check.outputs.needs_description == 'true'
        id: context
        run: |
          git fetch origin ${{ github.base_ref }} 2>/dev/null || true

          # Get diff stats
          STATS=$(git diff --stat origin/${{ github.base_ref }}...HEAD 2>/dev/null | tail -1 || echo "0 files changed")
          echo "stats=$STATS" >> $GITHUB_OUTPUT

          # Get commit messages
          git log --oneline origin/${{ github.base_ref }}...HEAD > commits.txt 2>/dev/null || touch commits.txt

          # Get changed files
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed-files.txt 2>/dev/null || touch changed-files.txt

          # Categorize changes
          COMPONENTS=$(grep -c "components/" changed-files.txt 2>/dev/null || echo 0)
          API=$(grep -c "api/" changed-files.txt 2>/dev/null || echo 0)
          TESTS=$(grep -cE "\.test\.|\.spec\." changed-files.txt 2>/dev/null || echo 0)
          DOCS=$(grep -cE "\.md$|docs/" changed-files.txt 2>/dev/null || echo 0)

          echo "components=$COMPONENTS" >> $GITHUB_OUTPUT
          echo "api=$API" >> $GITHUB_OUTPUT
          echo "tests=$TESTS" >> $GITHUB_OUTPUT
          echo "docs=$DOCS" >> $GITHUB_OUTPUT

          # Estimate review time (rough: 1 min per 20 lines changed)
          LINES=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")
          MINUTES=$((${LINES:-0} / 20 + 5))
          echo "review_mins=$MINUTES" >> $GITHUB_OUTPUT

      - name: Find related issues
        if: steps.check.outputs.needs_description == 'true'
        id: issues
        run: |
          # Look for issue references in commits and branch name
          BRANCH="${{ github.head_ref }}"
          ISSUES=$(echo "$BRANCH" | grep -oE '#[0-9]+|[0-9]+' | head -3 | tr '\n' ' ' || true)

          # Also check commits
          COMMIT_ISSUES=$(grep -ohE '#[0-9]+' commits.txt 2>/dev/null | sort -u | tr '\n' ' ' || true)

          echo "related=$ISSUES $COMMIT_ISSUES" >> $GITHUB_OUTPUT

      - name: Determine suggested reviewers
        if: steps.check.outputs.needs_description == 'true'
        id: reviewers
        run: |
          # Get top contributors to changed files
          REVIEWERS=""
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              CONTRIBUTOR=$(git log -1 --format='%an' -- "$file" 2>/dev/null || true)
              if [ -n "$CONTRIBUTOR" ] && [ "$CONTRIBUTOR" != "${{ github.event.pull_request.user.login }}" ]; then
                REVIEWERS="$REVIEWERS $CONTRIBUTOR"
              fi
            fi
          done < changed-files.txt

          # Dedupe and limit
          echo "$REVIEWERS" | tr ' ' '\n' | grep -v '^$' | sort | uniq | head -3 | tr '\n' ' ' > reviewers.txt
          echo "suggested=$(cat reviewers.txt)" >> $GITHUB_OUTPUT

      - name: Generate PR description
        if: steps.check.outputs.needs_description == 'true'
        id: generate
        uses: ./.github/actions/claude-analysis
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt_file: .github/agents/prompts/pr-prep.md
          context_files: |
            commits.txt
            changed-files.txt
            .github/agents/knowledge/codebase-map.json
          additional_context: |
            Stats: ${{ steps.context.outputs.stats }}
            Components changed: ${{ steps.context.outputs.components }}
            API changes: ${{ steps.context.outputs.api }}
            Tests: ${{ steps.context.outputs.tests }}
            Docs: ${{ steps.context.outputs.docs }}
            Estimated review time: ${{ steps.context.outputs.review_mins }} minutes
            Related issues: ${{ steps.issues.outputs.related }}
            Suggested reviewers: ${{ steps.reviewers.outputs.suggested }}
          output_mode: file
          output_file: pr-description.md

      - name: Update PR description
        if: steps.check.outputs.needs_description == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let description = '';
            try {
              description = fs.readFileSync('pr-description.md', 'utf8');
            } catch (e) {
              console.log('No description file found');
              return;
            }

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: description
            });

      - name: Add labels
        if: steps.check.outputs.needs_description == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [];

            // Size labels
            const stats = `${{ steps.context.outputs.stats }}`;
            const insertions = parseInt(stats.match(/(\d+) insertion/)?.[1] || 0);
            if (insertions < 50) labels.push('size/small');
            else if (insertions < 200) labels.push('size/medium');
            else labels.push('size/large');

            // Type labels
            const components = parseInt('${{ steps.context.outputs.components }}') || 0;
            const api = parseInt('${{ steps.context.outputs.api }}') || 0;
            const tests = parseInt('${{ steps.context.outputs.tests }}') || 0;
            const docs = parseInt('${{ steps.context.outputs.docs }}') || 0;

            if (components > 0) labels.push('area/frontend');
            if (api > 0) labels.push('area/backend');
            if (tests > 0) labels.push('includes/tests');
            if (docs > 0) labels.push('includes/docs');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }
